name: Validate Userscript

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate:
    name: Validate & Lint
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Validate userscript syntax
        run: |
          echo "ğŸ“œ Checking userscript file exists..."
          if [ ! -f "disable-yt-hotkeys.user.js" ]; then
            echo "âŒ Userscript file not found!"
            exit 1
          fi

          echo "âœ… Userscript file found"

          echo "ğŸ“ Checking file size..."
          size=$(wc -c < disable-yt-hotkeys.user.js)
          echo "File size: $size bytes"

          if [ $size -lt 1000 ]; then
            echo "âŒ File seems too small!"
            exit 1
          fi

          echo "âœ… File size OK"

      - name: ğŸ” Validate JSON files
        run: |
          echo "ğŸ“œ Validating MANIFEST.json..."
          if ! jq empty MANIFEST.json 2>/dev/null; then
            echo "âŒ MANIFEST.json is invalid!"
            exit 1
          fi
          echo "âœ… MANIFEST.json is valid"

          echo "ğŸ“œ Validating package.json..."
          if ! jq empty package.json 2>/dev/null; then
            echo "âŒ package.json is invalid!"
            exit 1
          fi
          echo "âœ… package.json is valid"

      - name: ğŸ” Check version consistency
        run: |
          echo "ğŸ“Œ Checking version consistency across files..."

          # Extract versions
          userscript_version=$(grep -oP '@version\s+\K[\d.]+' disable-yt-hotkeys.user.js)
          manifest_version=$(jq -r '.version' MANIFEST.json)
          readme_version=$(grep -oP 'version-\K[\d.]+' README.md | head -1)

          echo "Userscript version: $userscript_version"
          echo "Manifest version:   $manifest_version"
          echo "README version:     $readme_version"

          if [ "$userscript_version" != "$manifest_version" ]; then
            echo "âŒ Version mismatch between userscript and manifest!"
            exit 1
          fi

          if [ "$userscript_version" != "$readme_version" ]; then
            echo "âŒ Version mismatch between userscript and README!"
            exit 1
          fi

          echo "âœ… All versions match: $userscript_version"

      - name: ğŸ” Check required metadata
        run: |
          echo "ğŸ“œ Checking required userscript metadata..."

          required_metadata=(
            "@name"
            "@namespace"
            "@version"
            "@description"
            "@author"
            "@match"
            "@grant"
            "@license"
            "@homepageURL"
            "@supportURL"
            "@downloadURL"
            "@updateURL"
          )

          missing=0
          for meta in "${required_metadata[@]}"; do
            if ! grep -q "$meta" disable-yt-hotkeys.user.js; then
              echo "âŒ Missing metadata: $meta"
              missing=1
            else
              echo "âœ… Found: $meta"
            fi
          done

          if [ $missing -eq 1 ]; then
            echo "âŒ Some required metadata is missing!"
            exit 1
          fi

          echo "âœ… All required metadata present"

      - name: ğŸ“Š Summary
        if: success()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   âœ… All validations passed! âœ…   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Userscript is ready for deployment"
